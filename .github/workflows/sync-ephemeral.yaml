name: Manual Sync Ephemeral DB

# ============================================================================
# This workflow manually syncs the Ephemeral Neon Project (Project 2) with
# the latest migrations from the codebase.
#
# REQUIRED SECRET:
#   EPHEMERAL_DATABASE_URL_MAIN - This should be the DATABASE URL of the MAIN BRANCH
#                                  of your Ephemeral Neon Project (Project 2).
#                                  NOT the production database!
#
# Example: postgresql://user:pass@ep-xyz.neon.tech/neondb?sslmode=require
#          (Get this from Neon Dashboard → Project 2 → main branch → Connection String)
# ============================================================================

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type 'sync' to confirm manual sync"
        required: true
        type: string

# Environment variables for Prisma (non-DB related)
env:
  NODE_ENV: production
  PORT: 3000
  INTERNAL_PORT: 3001
  CLIENT_URL: http://localhost:3000
  ACCESS_TOKEN_SECRET: dummy
  REFRESH_TOKEN_SECRET: dummy
  ACCESS_TOKEN_EXPIRY: 15m
  REFRESH_TOKEN_EXPIRY: 7d
  SMTP_HOST: smtp.example.com
  SMTP_PORT: 587
  SMTP_USER: test@example.com
  SMTP_PASS: dummy
  REDIS_URL: redis://localhost:6379
  FORGOT_PASSWORD_REDIRECT_URL: http://localhost:3000/reset-password
  CLOUDINARY_CLOUD_NAME: dummy
  CLOUDINARY_API_KEY: dummy
  CLOUDINARY_API_SECRET: dummy

jobs:
  validate-input:
    name: Validate Input
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        if: ${{ github.event.inputs.confirm != 'sync' }}
        run: |
          echo "Error: You must type 'sync' to confirm"
          exit 1

  sync-ephemeral:
    name: Sync Ephemeral Database (Neon Project 2 - main branch)
    runs-on: ubuntu-latest
    needs: validate-input
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: Install dependencies (skip husky)
        run: npm ci --ignore-scripts

      # Uses EPHEMERAL_DATABASE_URL_MAIN secret
      # This should be: Neon Project 2 → main branch → Connection String
      - name: Generate Prisma Client
        run: npx prisma generate
        env:
          DATABASE_URL: ${{ secrets.EPHEMERAL_DATABASE_URL_MAIN }}

      - name: Sync migrations to Ephemeral main branch
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.EPHEMERAL_DATABASE_URL_MAIN }}

      - name: Verify sync status
        run: |
          npx prisma migrate status
          echo "✅ Ephemeral database (Project 2 main branch) synced successfully!"
        env:
          DATABASE_URL: ${{ secrets.EPHEMERAL_DATABASE_URL_MAIN }}
